<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyxalign.alignment.projection_matching &#8212; pyxalign 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyxalign.alignment.projection_matching</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cupy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">QApplication</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.alignment.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Aligner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.api.options.projections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProjectionTransformOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.api.options.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShiftOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.api.options_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_all_device_options</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxalign.data_structures.projections</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">projections</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.interactions.viewers.projection_matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProjectionMatchingViewer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.regularization</span><span class="w"> </span><span class="kn">import</span> <span class="n">chambolleLocalTV3D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.style.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">text_colors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.timing.timer_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">InlineTimer</span><span class="p">,</span> <span class="n">timer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.transformations.classes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Shifter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxalign.image_processing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxalign.api.maps</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">maps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.api.enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeviceType</span><span class="p">,</span> <span class="n">MemoryConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.api.options.alignment</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProjectionMatchingOptions</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyxalign.gpu_utils</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gutils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.api.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">r_type</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxalign.gpu_wrapper</span><span class="w"> </span><span class="kn">import</span> <span class="n">device_handling_wrapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astra</span>


<div class="viewcode-block" id="ProjectionMatchingAligner">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProjectionMatchingAligner</span><span class="p">(</span><span class="n">Aligner</span><span class="p">):</span>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">projections</span><span class="p">:</span> <span class="s2">&quot;projections.PhaseProjections&quot;</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">ProjectionMatchingOptions</span><span class="p">,</span>
        <span class="n">print_updates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">projections</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span> <span class="n">ProjectionMatchingOptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_updates</span> <span class="o">=</span> <span class="n">print_updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span> <span class="n">ProjectionMatchingViewer</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ProjectionMatchingAligner.run">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.run">[docs]</a>
    <span class="nd">@gutils</span><span class="o">.</span><span class="n">memory_releasing_error_handler</span>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_shift</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keep_on_gpu</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">gpu</span><span class="o">.</span><span class="n">gpu_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
        <span class="c1"># Create the projections object</span>
        <span class="n">projection_options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keep_on_gpu</span><span class="p">:</span>
            <span class="n">set_all_device_options</span><span class="p">(</span><span class="n">projection_options</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="n">projection_options</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">pixel_size</span>
        <span class="n">projection_options</span><span class="o">.</span><span class="n">input_processing</span> <span class="o">=</span> <span class="n">ProjectionTransformOptions</span><span class="p">(</span>
            <span class="n">downsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">downsample</span><span class="p">,</span>
            <span class="n">crop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">crop</span><span class="p">,</span>
            <span class="n">mask_downsample_use_gaussian_filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">downsample</span><span class="o">.</span><span class="n">use_gaussian_filter</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># projection_options.reconstruct = self.options.reconstruct</span>
        <span class="n">projection_options</span><span class="o">.</span><span class="n">reconstruct</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruct</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span> <span class="o">=</span> <span class="n">projections</span><span class="o">.</span><span class="n">PhaseProjections</span><span class="p">(</span>
            <span class="n">projections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">angles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span>
            <span class="n">scan_numbers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">scan_numbers</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">projection_options</span><span class="p">,</span>
            <span class="n">masks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">masks</span><span class="p">,</span>
            <span class="n">center_of_rotation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">center_of_rotation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">downsample</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">downsample</span><span class="o">.</span><span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># When cropping and not downsampling, you need to make a new copy</span>
        <span class="c1"># of the array. I don&#39;t fully understand why this is needed, but</span>
        <span class="c1"># this will break if you don&#39;t have it here.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">crop</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span> <span class="o">*</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">initial_shift</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">n_projections</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_shift</span> <span class="o">=</span> <span class="n">initial_shift</span>

        <span class="c1"># Run the PMA algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_alignment_shift</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_GUI</span><span class="p">(</span><span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># update GUI one last time</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_arrays_back_to_cpu</span><span class="p">()</span>

        <span class="c1"># Re-scale the shift</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># Clear astra objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">clear_astra_objects</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">shift</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.calculate_alignment_shift">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.calculate_alignment_shift">[docs]</a>
    <span class="nd">@gutils</span><span class="o">.</span><span class="n">memory_releasing_error_handler</span>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_alignment_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayType</span><span class="p">:</span>
        <span class="n">unshifted_masks</span><span class="p">,</span> <span class="n">unshifted_projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_arrays</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_attributes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_shifters</span><span class="p">()</span>
        <span class="n">tukey_window</span><span class="p">,</span> <span class="n">circulo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_windows</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting projection-matching alignment downsampling = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_updates</span><span class="p">:</span>
            <span class="n">loop_prog_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">iterations</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;projection matching loop&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loop_prog_bar</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">iterations</span><span class="p">)</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="ow">in</span> <span class="n">loop_prog_bar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">unshifted_projections</span><span class="p">,</span> <span class="n">unshifted_masks</span><span class="p">,</span> <span class="n">tukey_window</span><span class="p">,</span> <span class="n">circulo</span><span class="p">)</span>
            <span class="n">max_shift_step_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_size_update</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_updates</span><span class="p">:</span>
                <span class="n">prog_bar_update_string</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text_colors</span><span class="o">.</span><span class="n">HEADER</span><span class="si">}</span><span class="s2">Max step size update: </span><span class="si">{</span><span class="n">max_shift_step_size</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> px &quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">momentum_update_string</span><span class="si">}{</span><span class="n">text_colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">loop_prog_bar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">prog_bar_update_string</span><span class="p">)</span>
            <span class="n">stopping_condition_met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_stopping_condition</span><span class="p">(</span><span class="n">max_shift_step_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stopping_condition_met</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_for_error</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.iterate">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.iterate">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iterate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unshifted_projections</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">unshifted_masks</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">tukey_window</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">circulo</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="s2">&quot;Execute an iteration of the projection-matching aligment loop&quot;</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">apply_new_shift</span><span class="p">(</span><span class="n">unshifted_projections</span><span class="p">,</span> <span class="n">unshifted_masks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_window_to_masks</span><span class="p">(</span><span class="n">tukey_window</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">refine_geometry</span><span class="p">:</span>
            <span class="c1"># When using geometry refinement, the astra vectors need</span>
            <span class="c1"># to be updated on every iteration.</span>
            <span class="n">update_geometries</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update_geometries</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">generate_volume</span><span class="p">(</span>
            <span class="n">filter_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">pinned_filtered_sinogram</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_filtered_sinogram</span><span class="p">,</span>
            <span class="n">reinitialize_astra</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">n_pix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="p">,</span>
            <span class="n">update_geometries</span><span class="o">=</span><span class="n">update_geometries</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruction_mask</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">apply_circular_window</span><span class="p">(</span><span class="n">circulo</span><span class="p">)</span>
            <span class="c1"># Store data for the forward projection</span>
            <span class="n">astra</span><span class="o">.</span><span class="n">data3d</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">astra_config</span><span class="p">[</span><span class="s2">&quot;ReconstructionDataId&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regularize_reconstruction</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">iterations</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Get forward projection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">get_forward_projection</span><span class="p">(</span>
            <span class="n">pinned_forward_projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_forward_projection</span><span class="p">,</span>
            <span class="n">forward_projection_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">astra_config</span><span class="p">[</span>
                <span class="s2">&quot;ProjectionDataId&quot;</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># Find optimal shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_shift_update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_GUI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_geometry_update</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.apply_new_shift">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.apply_new_shift">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_new_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unshifted_projections</span><span class="p">,</span> <span class="n">unshifted_masks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_shifter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">images</span><span class="o">=</span><span class="n">unshifted_projections</span><span class="p">,</span>
            <span class="n">shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span><span class="p">,</span>
            <span class="n">pinned_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_shifter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">images</span><span class="o">=</span><span class="n">unshifted_masks</span><span class="p">,</span>
            <span class="n">shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span><span class="p">,</span>
            <span class="n">pinned_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">,</span>
            <span class="n">is_binary_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.initialize_attributes">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.initialize_attributes">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">reconstructed_object_dimensions</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="c1"># Prepare pre-allocated and pinned arrays</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">CPU_ONLY</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_filtered_sinogram</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_forward_projection</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">n_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">n_projections</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">MIXED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_lamino_angle_correction</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_tilt_angle_correction</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_skew_angle_correction</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_lamino_angle_correction</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_tilt_angle_correction</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_skew_angle_correction</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_proj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_filtered_sinogram</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_forward_projection</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_lamino_angle_correction</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_tilt_angle_correction</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_skew_angle_correction</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_unfiltered_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_max_shift_step_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_shifts_before_momentum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_shift_updates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_momentum_acceleration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_friction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">momentum_update_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_lamino_angle_updates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_tilt_angle_updates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_skew_angle_updates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.get_shift_update">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.get_shift_update">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_shift_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Later, you could update the gpu wrapper</span>
        <span class="c1"># to move arrays to the gpu in chunks if they</span>
        <span class="c1"># are on the cpu. For now, just move the whole</span>
        <span class="c1"># array.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="n">forward_projection_input</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">data</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">forward_projection_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># if self.memory_config == MemoryConfig.GPU_ONLY:</span>
        <span class="c1">#     self.aligned_projections.volume.forward_projections.data = cp.array(</span>
        <span class="c1">#         self.aligned_projections.volume.forward_projections.data</span>
        <span class="c1">#     )</span>

        <span class="n">inline_timer</span> <span class="o">=</span> <span class="n">InlineTimer</span><span class="p">(</span><span class="s2">&quot;wrapped get_shift_update&quot;</span><span class="p">)</span>
        <span class="n">inline_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">wrapped_shift_calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_wrapped_get_shift_update</span><span class="p">()</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">wrapped_shift_calc_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">,</span>
            <span class="n">forward_projection_input</span><span class="p">,</span>
            <span class="c1"># self.aligned_projections.volume.forward_projections.data,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">high_pass_filter</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">filter_directions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inline_timer</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_process_shift</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_errors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_unfiltered_errors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_shift_updates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_errors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span> <span class="o">*</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_unfiltered_errors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span> <span class="o">*</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_shift_updates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.post_process_shift">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.post_process_shift">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">post_process_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span>

        <span class="c1"># Reduce the shift on this increment by a relaxation factor</span>
        <span class="n">max_allowed_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">max_step_size</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_allowed_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_allowed_step</span> <span class="o">*</span> <span class="n">xp</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">step_relax</span>

        <span class="c1"># apply momentum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_shifts_before_momentum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_shifts_before_momentum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_shift_momentum</span><span class="p">()</span>

        <span class="c1"># Center the shifts around zero in the vertical direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xp</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Prevent outliers if the result begins quickly oscillating around the solution</span>
        <span class="n">max_recorded_step</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">),</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_recorded_step</span><span class="p">[</span><span class="n">max_recorded_step</span> <span class="o">&gt;</span> <span class="n">max_allowed_step</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_allowed_step</span>

        <span class="c1"># Do not allow more than max_allowed_step px per iteration</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_allowed_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">max_recorded_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">xp</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="c1"># Remove degree of freedom in the vertical dimension (avoid drifts)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>
        <span class="n">orthbase</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span> <span class="o">*</span> <span class="n">xp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">),</span> <span class="n">xp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span> <span class="o">*</span> <span class="n">xp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">orthbase</span><span class="p">,</span> <span class="n">orthbase</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">orthbase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">B</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>

        <span class="c1"># Avoid object drifts within the reconstructed field of view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">orthbase</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">coefs</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.get_shift_momentum">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.get_shift_momentum">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_shift_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_shifts_before_momentum</span><span class="p">)</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">memory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">&gt;=</span> <span class="n">memory</span><span class="p">:</span>
            <span class="n">max_update</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">),</span> <span class="mf">0.995</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">eligible_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_update</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
                <span class="n">eligible_axes</span> <span class="o">=</span> <span class="n">eligible_axes</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_momentum_to_shift_update</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">eligible_axes</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.fminsearch">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.fminsearch">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fminsearch</span><span class="p">(</span><span class="n">C</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">initial_guess</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># Define the objective function</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
            <span class="n">n_mem</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>  <span class="c1"># Nmem should be the length of C</span>
            <span class="c1"># Create the array equivalent to MATLAB&#39;s [Nmem:-1:1]</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Ensure that the array length matches the number of elements in C</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">*</span> <span class="n">arr</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">initial_guess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Nelder-Mead&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.add_momentum_to_shift_update">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.add_momentum_to_shift_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_momentum_to_shift_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_shifts_before_momentum</span><span class="p">)</span>
        <span class="n">idx_memory</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span>
        <span class="n">n_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">memory</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">pearson_corr_coeffs</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_mem</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_mem</span><span class="p">):</span>
                <span class="n">pearson_corr_coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span>
                    <span class="n">shift</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_shifts_before_momentum</span><span class="p">[</span><span class="n">idx_memory</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">:,</span> <span class="n">ax</span><span class="p">]</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># estimate friction</span>
            <span class="n">decay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fminsearch</span><span class="p">(</span><span class="n">pearson_corr_coeffs</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">friction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">decay</span><span class="p">])</span>
            <span class="n">friction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">friction</span><span class="p">])</span>
            <span class="c1"># update velocity map</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">velocity_map</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">friction</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_map</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span>
            <span class="c1"># update shift estimates</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">gain</span>
            <span class="n">shift</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gain</span><span class="p">)</span> <span class="o">*</span> <span class="n">shift</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_map</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span>

        <span class="c1"># reinforce the reference, in case you make edits later and accidentally</span>
        <span class="c1"># remove the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">=</span> <span class="n">shift</span>

        <span class="c1"># Save quantities to print to user</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">momentum_acceleration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_shifts_before_momentum</span><span class="p">[</span><span class="n">idx_memory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_momentum_acceleration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_momentum_acceleration</span><span class="p">,</span> <span class="n">momentum_acceleration</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_friction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_friction</span><span class="p">,</span> <span class="n">friction</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">momentum_update_string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text_colors</span><span class="o">.</span><span class="n">OKCYAN</span><span class="si">}</span><span class="s2">Momentum acceleration: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">momentum_acceleration</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">floatmode</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text_colors</span><span class="o">.</span><span class="n">OKGREEN</span><span class="si">}</span><span class="s2">Friction: </span><span class="si">{</span><span class="n">friction</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}{</span><span class="n">text_colors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.return_wrapped_get_shift_update">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.return_wrapped_get_shift_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_wrapped_get_shift_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">pinned_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pinned_results</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">wrapped_func</span> <span class="o">=</span> <span class="n">device_handling_wrapper</span><span class="p">(</span>
            <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_shift_update</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">chunkable_inputs_for_gpu_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">common_inputs_for_gpu_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="n">pinned_results</span><span class="o">=</span><span class="n">pinned_results</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapped_func</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.calculate_shift_update">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.calculate_shift_update">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_shift_update</span><span class="p">(</span>
        <span class="n">sinogram</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">masks</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">forward_projection_model</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">high_pass_filter</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">mass</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">secondary_mask</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">filter_directions</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,),</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ArrayType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">]:</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">sinogram</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">secondary_mask</span> <span class="o">*</span> <span class="n">masks</span>

        <span class="n">projections_residuals</span> <span class="o">=</span> <span class="n">forward_projection_model</span> <span class="o">-</span> <span class="n">sinogram</span>

        <span class="c1"># calculate error using unfiltered residual</span>
        <span class="n">unfiltered_error</span> <span class="o">=</span> <span class="n">get_pm_error</span><span class="p">(</span><span class="n">projections_residuals</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">mass</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">filter_directions</span><span class="p">:</span>
            <span class="n">projections_residuals</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">apply_1D_high_pass_filter</span><span class="p">(</span>
                <span class="n">projections_residuals</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">high_pass_filter</span>
            <span class="p">)</span>

        <span class="c1"># calculate error using filtered residual</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">get_pm_error</span><span class="p">(</span><span class="n">projections_residuals</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">mass</span><span class="p">)</span>

        <span class="c1"># Calculate the alignment shift</span>
        <span class="n">dX</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">get_filtered_image_gradient</span><span class="p">(</span><span class="n">forward_projection_model</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">high_pass_filter</span><span class="p">)</span>
        <span class="n">dX</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">apply_1D_high_pass_filter</span><span class="p">(</span><span class="n">dX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">high_pass_filter</span><span class="p">)</span>
        <span class="n">x_shift</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span>
            <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masks</span> <span class="o">*</span> <span class="n">dX</span> <span class="o">*</span> <span class="n">projections_residuals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">/</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masks</span> <span class="o">*</span> <span class="n">dX</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">dX</span>

        <span class="n">dY</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">get_filtered_image_gradient</span><span class="p">(</span><span class="n">forward_projection_model</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">high_pass_filter</span><span class="p">)</span>
        <span class="n">dY</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">apply_1D_high_pass_filter</span><span class="p">(</span><span class="n">dY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">high_pass_filter</span><span class="p">)</span>
        <span class="n">y_shift</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span>
            <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masks</span> <span class="o">*</span> <span class="n">dY</span> <span class="o">*</span> <span class="n">projections_residuals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">/</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masks</span> <span class="o">*</span> <span class="n">dY</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">dY</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_shift</span><span class="p">,</span> <span class="n">y_shift</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">r_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shift</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">unfiltered_error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shift</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">dY</span><span class="p">,</span> <span class="n">projections_residuals</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.apply_window_to_masks">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.apply_window_to_masks">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_window_to_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tukey_window</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="c1"># self.aligned_projections.masks[:] = tukey_window * self.aligned_projections.masks</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">multiply_window_and_mask</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">tukey_window</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tukey_window</span> <span class="o">*</span> <span class="n">masks</span>

        <span class="n">apply_window_wrapped</span> <span class="o">=</span> <span class="n">device_handling_wrapper</span><span class="p">(</span>
            <span class="n">func</span><span class="o">=</span><span class="n">multiply_window_and_mask</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">chunkable_inputs_for_gpu_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">common_inputs_for_gpu_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">pinned_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">apply_window_wrapped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">,</span> <span class="n">tukey_window</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.regularize_reconstruction">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.regularize_reconstruction">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">regularize_reconstruction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">regularization</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">chambolleLocalTV3D</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">regularization</span><span class="o">.</span><span class="n">local_TV_lambda</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">regularization</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Store the updated reconstruction</span>
            <span class="n">astra</span><span class="o">.</span><span class="n">data3d</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">astra_config</span><span class="p">[</span><span class="s2">&quot;ReconstructionDataId&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.initialize_arrays">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.initialize_arrays">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">get_memory_config_enum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keep_on_gpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">device_type</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">gpu</span><span class="o">.</span><span class="n">gpu_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">use</span><span class="p">()</span>
            <span class="n">initializer_function</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scipy_module</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">get_scipy_module</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">MIXED</span><span class="p">:</span>
            <span class="n">initializer_function</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">force_repin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xp</span> <span class="o">=</span> <span class="n">np</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scipy_module</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">get_scipy_module</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">CPU_ONLY</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">initializer_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># noqa: E731</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xp</span> <span class="o">=</span> <span class="n">np</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scipy_module</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">get_scipy_module</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">unshifted_projections</span> <span class="o">=</span> <span class="n">initializer_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">unshifted_masks</span> <span class="o">=</span> <span class="n">initializer_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">CPU_ONLY</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">initializer_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">initializer_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span>
        <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_shift</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unshifted_masks</span><span class="p">,</span> <span class="n">unshifted_projections</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.initialize_shifters">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.initialize_shifters">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_shifters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">device_options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="n">device_options</span><span class="o">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">GPU</span>

        <span class="n">projections_shift_options</span> <span class="o">=</span> <span class="n">ShiftOptions</span><span class="p">(</span>
            <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">projection_shift_type</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device_options</span><span class="p">,</span>
            <span class="n">eliminate_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">prevent_wrapping_from_shift</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mask_shift_options</span> <span class="o">=</span> <span class="n">ShiftOptions</span><span class="p">(</span>
            <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mask_shift_type</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device_options</span><span class="p">,</span>
            <span class="n">eliminate_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">prevent_wrapping_from_shift</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">projection_shifter</span> <span class="o">=</span> <span class="n">Shifter</span><span class="p">(</span><span class="n">projections_shift_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_shifter</span> <span class="o">=</span> <span class="n">Shifter</span><span class="p">(</span><span class="n">mask_shift_options</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.initialize_windows">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.initialize_windows">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ArrayType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">]:</span>
        <span class="c1"># Generate window for removing edge issues</span>
        <span class="n">tukey_window</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">get_tukey_window</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tukey_shape_parameter</span><span class="p">,</span> <span class="n">xp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xp</span>
        <span class="p">)</span>

        <span class="c1"># Generate circular mask for reconstruction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruction_mask</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="n">circulo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">get_circular_window</span><span class="p">(</span>
                <span class="n">radial_smooth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruction_mask</span><span class="o">.</span><span class="n">radial_smooth</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                <span class="n">rad_apod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruction_mask</span><span class="o">.</span><span class="n">rad_apod</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">circulo</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Generate secondary masks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">secondary_mask</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">generate_projection_masks_from_circulo</span><span class="p">(</span>
                    <span class="n">radial_smooth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">secondary_mask</span><span class="o">.</span><span class="n">radial_smooth</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                    <span class="n">rad_apod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">secondary_mask</span><span class="o">.</span><span class="n">rad_apod</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">MIXED</span><span class="p">:</span>
            <span class="n">tukey_window</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span><span class="n">tukey_window</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tukey_window</span><span class="p">,</span> <span class="n">circulo</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.move_arrays_back_to_cpu">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.move_arrays_back_to_cpu">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">move_arrays_back_to_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_error</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_unfiltered_error</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_lamino_angle_correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_lamino_angle_correction</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_tilt_angle_correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_tilt_angle_correction</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pinned_skew_angle_correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinned_skew_angle_correction</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.get_step_size_update">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.get_step_size_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_step_size_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># Check if the step size update is small enough to stop the loop</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xp</span>
        <span class="n">max_shift_step_size</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">xp</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_update</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span> <span class="mf">0.995</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="n">max_shift_step_size</span> <span class="o">=</span> <span class="n">max_shift_step_size</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_max_shift_step_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_max_shift_step_size</span><span class="p">,</span> <span class="n">max_shift_step_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">max_shift_step_size</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.check_stopping_condition">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.check_stopping_condition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_stopping_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_shift_step_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">max_shift_step_size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">min_step_size</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">min_iterations</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum step size reached, stopping loop...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.run_with_GUI">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.run_with_GUI">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_with_GUI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_shift</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="s2">&quot;Launches the PMA viewer gui and runs the PMA loop&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span> <span class="ow">or</span> <span class="n">QApplication</span><span class="p">([])</span>
        <span class="c1"># Objective: make this interactive</span>
        <span class="c1"># I could delay starting the thread until after the user hits a button.</span>
        <span class="c1"># However, this makes setting up multi-resolution runs difficult.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">ProjectionMatchingViewer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_thread_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">start_thread</span><span class="p">(</span><span class="n">initial_shift</span><span class="o">=</span><span class="n">initial_shift</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">finish_test</span><span class="p">()</span>
        <span class="c1"># closing the window during destroys the QThread reference</span>
        <span class="c1"># app.exec_() # this makes it so the user has to close the window before moving on</span>
        <span class="k">return</span> <span class="n">shift</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.update_GUI">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.update_GUI">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_GUI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="s2">&quot;Update gui plots with data from the last PMA iteration&quot;</span>
        <span class="n">gui_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">interactive_viewer</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">enabled</span>
        <span class="n">stride_condition_met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">interactive_viewer</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">stride</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">gui_enabled</span> <span class="ow">and</span> <span class="p">(</span><span class="n">force_update</span> <span class="ow">or</span> <span class="n">stride_condition_met</span><span class="p">):</span>
            <span class="c1"># Prevent PMA thread execution until the gui plot update has</span>
            <span class="c1"># finished. This is probably unecessary.</span>
            <span class="c1"># t0 = time.time()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">initialize_plots</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">update_plots</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">wait_cond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">mutex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span></div>

            <span class="c1"># print(f&quot;unlocked, {time.time() - t0}&quot;)</span>

<div class="viewcode-block" id="ProjectionMatchingAligner.check_for_error">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.check_for_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_for_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">interactive_viewer</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">force_stop</span><span class="p">:</span>
            <span class="c1"># self.gui.finish_test() # unecessary?</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;User manually stopped execution&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.show_GUI">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.show_GUI">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_GUI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Relaunch the viewer. Intended to be used after running PMA and closing the original gui.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span> <span class="ow">or</span> <span class="n">QApplication</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">ProjectionMatchingViewer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">initialize_plots</span><span class="p">(</span><span class="n">add_stop_button</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">update_plots</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span> <span class="ow">or</span> <span class="n">QApplication</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.plot_update">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.plot_update">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">stride</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="c1"># matplotlib.use(&quot;module://matplotlib_inline.backend_inline&quot;)</span>
            <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>
            <span class="n">sorted_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
            <span class="n">total_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
            <span class="n">initial_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_shift</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keep_on_gpu</span><span class="p">:</span>
                <span class="n">total_shift</span> <span class="o">=</span> <span class="n">total_shift</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="n">pixel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">pixel_size</span>

            <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="s2">&quot;compressed&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">total_shift_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">new_shift_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">rec_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">proj_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">forward_proj_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">error_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">error_vs_iter_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">unfiltered_error_vs_iter_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Projection-matching alignment</span><span class="se">\n</span><span class="s2">Iteration </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">total_shift_axis</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Alignment shift&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Shift (px)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Angle (deg)&quot;</span><span class="p">)</span>
            <span class="n">initial_shift_colors</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">sorted_angles</span><span class="p">,</span> <span class="n">initial_shift</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">initial_shift_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_angles</span><span class="p">,</span> <span class="n">total_shift</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">sorted_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sorted_angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>

            <span class="n">twin_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">twin_ax</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">y</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ylim</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Shift ($\mu m$)&quot;</span><span class="p">)</span>
            <span class="n">ax_color</span> <span class="o">=</span> <span class="s2">&quot;palevioletred&quot;</span>
            <span class="n">twin_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">ax_color</span><span class="p">)</span>
            <span class="n">twin_ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">ax_color</span><span class="p">)</span>
            <span class="n">twin_ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">ax_color</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">new_shift_axis</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;total_shift - initial_shift&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Shift (px)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Angle (deg)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_angles</span><span class="p">,</span> <span class="n">total_shift</span> <span class="o">-</span> <span class="n">initial_shift</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">sorted_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sorted_angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

            <span class="n">ylim</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
            <span class="n">twin_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">twin_ax</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">y</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ylim</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Shift ($\mu m$)&quot;</span><span class="p">)</span>
            <span class="n">ax_color</span> <span class="o">=</span> <span class="s2">&quot;palevioletred&quot;</span>
            <span class="n">twin_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">ax_color</span><span class="p">)</span>
            <span class="n">twin_ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">ax_color</span><span class="p">)</span>
            <span class="n">twin_ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">ax_color</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">rec_axis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">reconstruction</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">proj_axis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">projections</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">forward_proj_axis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">projections</span><span class="p">,</span> <span class="n">title_string</span><span class="o">=</span><span class="s2">&quot;Forward Projection&quot;</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">error_axis</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
            <span class="c1"># plt.plot(</span>
            <span class="c1">#     sorted_angles,</span>
            <span class="c1">#     self.all_unfiltered_errors[self.iteration, sort_idx],</span>
            <span class="c1">#     label=&quot;Unfiltered&quot;,</span>
            <span class="c1"># )</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">sorted_angles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_errors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">,</span> <span class="n">sort_idx</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filtered&quot;</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Angle (deg)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">error_vs_iter_axis</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Error vs Iteration&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_errors</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filtered&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean Error&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">unfiltered_error_vs_iter_axis</span><span class="p">)</span>
            <span class="c1"># plt.title(&quot;Error vs Iteration&quot;)</span>
            <span class="c1"># plt.plot(self.all_unfiltered_errors[: self.iteration].mean(axis=1), label=&quot;Unfiltered&quot;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Max step size update&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_max_shift_step_size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Update size&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="c1"># fig.tight_layout()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.debug_get_shift_update">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.debug_get_shift_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">debug_get_shift_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">wrapped_shift_calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_wrapped_get_shift_update</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">dY</span><span class="p">,</span> <span class="n">projections_residuals</span><span class="p">)</span> <span class="o">=</span> <span class="n">wrapped_shift_calc_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">high_pass_filter</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">filter_directions</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">shift</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">dY</span><span class="p">,</span> <span class="n">projections_residuals</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.plot_shift_update_arrays_for_debugging">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.plot_shift_update_arrays_for_debugging">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_shift_update_arrays_for_debugging</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">shift</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">dX</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">dY</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">projections_residuals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">arrays_clim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gradient_clim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">numerator_clim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">denominator_clim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_colorbars</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dX</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">forward_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary_mask</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;compressed&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Arrays for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Plot projection, forward projection, and residual</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Projection&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">arrays_clim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Forward Projection&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">forward_proj</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">arrays_clim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Residual&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">proj</span> <span class="o">-</span> <span class="n">forward_proj</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">arrays_clim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Masked and Filtered Residual&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">projections_residuals</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">arrays_clim</span><span class="p">)</span>

        <span class="c1"># Plot image gradients</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dX&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dX</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">gradient_clim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dY&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dY</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">gradient_clim</span><span class="p">)</span>

        <span class="c1"># Plot numerator of shift calculation</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;dX $\times$ residual $\times$ mask&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dX</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">projections_residuals</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">numerator_clim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;dY $\times$ residual $\times$ mask&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dY</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">projections_residuals</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">numerator_clim</span><span class="p">)</span>

        <span class="c1"># Plot denominator of shift calculation</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;dX$^2$ $\times$ mask&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="n">dX</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">denominator_clim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;dY$^2$ $\times$ mask&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="n">dY</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bone&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">denominator_clim</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">use_colorbars</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;compressed&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Shift (px)&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total Shift&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">total_shift</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)[</span><span class="n">sort_idx</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Shift Update&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shift</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProjectionMatchingAligner.get_geometry_update">
<a class="viewcode-back" href="../../../_autosummary/pyxalign.data_structures.task.html#pyxalign.data_structures.task.ProjectionMatchingAligner.get_geometry_update">[docs]</a>
    <span class="nd">@timer</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_geometry_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">refine_geometry</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="n">deltas</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="p">]</span>
        <span class="c1"># offset_forward_projections = []</span>

        <span class="c1"># Get sinogram model at +/- a delta on the laminography angle</span>
        <span class="c1"># Get &#39;infinitesmal&#39; difference of model sinogram with respect to the sinogram angle</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="n">forward_projections</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">data</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">forward_projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="n">laminography_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">laminography_angle</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">laminography_angle</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">laminography_angle</span> <span class="o">+</span> <span class="n">deltas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># get volume at new laminography angle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">generate_volume</span><span class="p">(</span>
                <span class="n">filter_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">pinned_filtered_sinogram</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_filtered_sinogram</span><span class="p">,</span>
                <span class="n">reinitialize_astra</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">n_pix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="p">,</span>
                <span class="n">update_geometries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># get forward projections at new laminography angle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">get_forward_projection</span><span class="p">(</span>
                <span class="n">pinned_forward_projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pinned_forward_projection</span><span class="p">,</span>
                <span class="n">forward_projection_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">astra_config</span><span class="p">[</span>
                    <span class="s2">&quot;ProjectionDataId&quot;</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d_proj</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_proj</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">forward_projections</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span>
                <span class="p">)</span>
        <span class="c1"># Revert the laminography angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">laminography_angle</span> <span class="o">=</span> <span class="n">laminography_angle</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_gd_update</span><span class="p">(</span><span class="n">dX</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
            <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">dX</span><span class="p">)</span>
            <span class="n">dX</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">apply_1D_high_pass_filter</span><span class="p">(</span><span class="n">dX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span>
            <span class="n">optimal_shift</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">residual</span> <span class="o">*</span> <span class="n">dX</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">weights</span> <span class="o">*</span> <span class="n">dX</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">optimal_shift</span>

        <span class="c1"># add the thing for handling forward projection models here! they need to be</span>
        <span class="c1"># moved to gpu in the gpu_only case.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
            <span class="n">d_proj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d_proj</span><span class="p">)</span>

        <span class="c1"># gpu chunked inputs: forward_projections, projections, d_proj</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">calculate_geometry_update</span><span class="p">(</span>
            <span class="n">forward_projections</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
            <span class="n">projections</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
            <span class="n">d_proj</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
            <span class="n">weights</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span>
            <span class="n">high_pass_filter</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span>
            <span class="n">projections_residuals</span> <span class="o">=</span> <span class="n">forward_projections</span> <span class="o">-</span> <span class="n">projections</span>
            <span class="n">projections_residuals</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">apply_1D_high_pass_filter</span><span class="p">(</span>
                <span class="n">projections_residuals</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">high_pass_filter</span>
            <span class="p">)</span>
            <span class="n">dX</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">get_filtered_image_gradient</span><span class="p">(</span><span class="n">forward_projections</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">use_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">dY</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">get_filtered_image_gradient</span><span class="p">(</span><span class="n">forward_projections</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">use_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># get laminography angle correction</span>
            <span class="n">lamino_angle_correction</span> <span class="o">=</span> <span class="n">get_gd_update</span><span class="p">(</span>
                <span class="n">d_proj</span><span class="p">,</span> <span class="n">projections_residuals</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">high_pass_filter</span>
            <span class="p">)</span>
            <span class="c1"># get tilt angle correction</span>
            <span class="n">d_vec</span> <span class="o">=</span> <span class="n">dX</span> <span class="o">*</span> <span class="n">xp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dX</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">dY</span> <span class="o">*</span> <span class="n">xp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dY</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span>
            <span class="p">)</span>
            <span class="n">tilt_angle_correction</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">get_gd_update</span><span class="p">(</span>
                    <span class="n">d_vec</span><span class="p">,</span> <span class="n">projections_residuals</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">high_pass_filter</span><span class="p">)</span> <span class="o">*</span>
                <span class="mi">180</span> <span class="o">/</span> <span class="n">xp</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="c1"># get skew angle correction</span>
            <span class="n">d_vec</span> <span class="o">=</span> <span class="n">dY</span> <span class="o">*</span> <span class="n">xp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dY</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r_type</span><span class="p">)</span>
            <span class="n">skew_angle_correction</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">get_gd_update</span><span class="p">(</span>
                    <span class="n">d_vec</span><span class="p">,</span> <span class="n">projections_residuals</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">high_pass_filter</span><span class="p">)</span> <span class="o">*</span>
                <span class="mi">180</span> <span class="o">/</span> <span class="n">xp</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">lamino_angle_correction</span><span class="p">,</span> <span class="n">tilt_angle_correction</span><span class="p">,</span> <span class="n">skew_angle_correction</span>

        <span class="n">calculate_geometry_update_wrapped</span> <span class="o">=</span> <span class="n">device_handling_wrapper</span><span class="p">(</span>
            <span class="n">calculate_geometry_update</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">refine_geometry</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">chunkable_inputs_for_gpu_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="c1"># common_inputs_for_gpu_idx=[4],</span>
            <span class="n">pinned_results</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_lamino_angle_correction</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_tilt_angle_correction</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinned_skew_angle_correction</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">inline_timer</span> <span class="o">=</span> <span class="n">InlineTimer</span><span class="p">(</span><span class="s2">&quot;calculate_geometry_update_wrapped&quot;</span><span class="p">)</span>
        <span class="n">inline_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_lamino_angle_correction</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_tilt_angle_correction</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_skew_angle_correction</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">calculate_geometry_update_wrapped</span><span class="p">(</span>
            <span class="n">forward_projections</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">d_proj</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">masks</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">high_pass_filter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inline_timer</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

        <span class="c1"># Update angles</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_angle_update</span><span class="p">(</span><span class="n">angle_correction</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">step_relax</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">angle_update</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">angle_correction</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_config</span> <span class="o">==</span> <span class="n">MemoryConfig</span><span class="o">.</span><span class="n">GPU_ONLY</span><span class="p">:</span>
                <span class="n">angle_update</span> <span class="o">=</span> <span class="n">angle_update</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">angle_update</span> <span class="o">=</span> <span class="n">angle_update</span> <span class="o">*</span> <span class="n">step_relax</span>
            <span class="k">return</span> <span class="n">angle_update</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">laminography_angle</span> <span class="o">+=</span> <span class="n">get_angle_update</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_lamino_angle_correction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">refine_geometry</span><span class="o">.</span><span class="n">lamino_step_relax</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruct</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tilt_angle</span> <span class="o">+=</span> <span class="n">get_angle_update</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_tilt_angle_correction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">refine_geometry</span><span class="o">.</span><span class="n">tilt_step_relax</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruct</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">skew_angle</span> <span class="o">+=</span> <span class="n">get_angle_update</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pinned_skew_angle_correction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">refine_geometry</span><span class="o">.</span><span class="n">skew_step_relax</span>
        <span class="p">)</span>

        <span class="c1"># Store updated results for plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_lamino_angle_updates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_lamino_angle_updates</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">laminography_angle</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_tilt_angle_updates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_tilt_angle_updates</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruct</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tilt_angle</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_skew_angle_updates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_skew_angle_updates</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_projections</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">reconstruct</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">skew_angle</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">get_pm_error</span><span class="p">(</span><span class="n">projections_residuals</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">masks</span><span class="p">:</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">mass</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">projections_residuals</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">masks</span> <span class="o">*</span> <span class="n">projections_residuals</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="n">mass</span>
    <span class="k">return</span> <span class="n">error</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">r_type</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">pyxalign</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Argonne National Laboratory.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>